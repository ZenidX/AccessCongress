rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS (Optimized with Custom Claims)
    // ============================================
    //
    // Las funciones usan Custom Claims del token JWT en lugar de leer
    // el documento de usuario de Firestore. Esto elimina reads adicionales
    // y mejora el rendimiento.
    //
    // Custom Claims disponibles:
    // - request.auth.token.role: rol del usuario
    // - request.auth.token.orgId: organizationId del usuario
    // - request.auth.token.events: array de eventIds asignados
    //

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is super admin (by email - fallback)
    function isSuperAdmin() {
      return isAuthenticated() &&
             request.auth.token.email.lower() == 'zenid77@gmail.com';
    }

    // Check if user has a specific role (using Custom Claims)
    function hasRole(role) {
      return isAuthenticated() && request.auth.token.role == role;
    }

    // Get user role from Custom Claims
    function getUserRole() {
      return request.auth.token.role;
    }

    // Get user organization from Custom Claims
    function getUserOrgId() {
      return request.auth.token.orgId;
    }

    // Check if user is any admin role (using Custom Claims)
    function isAnyAdmin() {
      return isSuperAdmin() ||
             hasRole('admin_responsable') ||
             hasRole('admin');
    }

    // Check if user belongs to organization (using Custom Claims)
    function belongsToOrganization(orgId) {
      return isAuthenticated() && request.auth.token.orgId == orgId;
    }

    // Check if user can access event (using Custom Claims)
    // NOTE: Still needs one get() for event data to check organizationId
    function canAccessEvent(eventId) {
      let eventData = get(/databases/$(database)/documents/events/$(eventId)).data;

      // Super admin can access all events
      // Admin roles can access events in their organization
      // Controllers can only access assigned events in their token
      return isSuperAdmin() ||
             (getUserRole() in ['admin_responsable', 'admin'] && eventData.organizationId == getUserOrgId()) ||
             (getUserRole() == 'controlador' && eventId in request.auth.token.events);
    }

    // Legacy: Get user data from Firestore (only for user document rules)
    // Used sparingly where we need to read the actual document being modified
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // ============================================
    // ORGANIZATIONS
    // ============================================
    match /organizations/{orgId} {
      // Super admin can read all
      // Users can read their own organization
      allow read: if isSuperAdmin() || belongsToOrganization(orgId);

      // Only super admin can create organizations
      allow create: if isSuperAdmin();

      // Admin responsable can update their own organization
      allow update: if isSuperAdmin() ||
                      (hasRole('admin_responsable') && belongsToOrganization(orgId));

      // Only super admin can delete organizations
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // EVENTS
    // ============================================
    match /events/{eventId} {
      // Allow read if user can access the event
      // Using Custom Claims - NO Firestore reads needed!
      allow read: if isSuperAdmin() ||
                    (getUserRole() in ['admin_responsable', 'admin'] &&
                     resource.data.organizationId == getUserOrgId()) ||
                    (getUserRole() == 'controlador' &&
                     eventId in request.auth.token.events);

      // Admin roles can create events in their organization
      allow create: if isAnyAdmin();

      // Admin roles can update events they can access
      allow update: if isAnyAdmin() && canAccessEvent(eventId);

      // Only super admin and admin_responsable can delete events
      allow delete: if isSuperAdmin() ||
                      (hasRole('admin_responsable') && canAccessEvent(eventId));

      // ============================================
      // EVENT PARTICIPANTS (subcollection)
      // ============================================
      match /participants/{participantId} {
        // Anyone who can access the event can read participants
        allow read: if canAccessEvent(eventId);

        // Admin roles can write participants
        allow create, update: if isAnyAdmin() && canAccessEvent(eventId);

        // Controllers can update participant status (for scanning)
        allow update: if hasRole('controlador') && canAccessEvent(eventId);

        // Only admin roles can delete participants
        allow delete: if isAnyAdmin() && canAccessEvent(eventId);
      }

      // ============================================
      // EVENT ACCESS LOGS (subcollection)
      // ============================================
      match /access_logs/{logId} {
        // Anyone who can access the event can read logs
        allow read: if canAccessEvent(eventId);

        // Anyone who can access the event can create logs (scanning)
        allow create: if canAccessEvent(eventId);

        // Logs should not be updated or deleted
        allow update, delete: if false;
      }

      // ============================================
      // EMAIL TEMPLATES (subcollection)
      // ============================================
      match /emailTemplates/{templateId} {
        // Admin roles can read templates for events they can access
        allow read: if isAnyAdmin() && canAccessEvent(eventId);

        // Admin roles can create/update/delete templates
        allow create, update, delete: if isAnyAdmin() && canAccessEvent(eventId);
      }

      // ============================================
      // EMAIL LOGS (subcollection)
      // ============================================
      match /emailLogs/{logId} {
        // Admin roles can read email logs
        allow read: if isAnyAdmin() && canAccessEvent(eventId);

        // Only Cloud Functions can create logs (via admin SDK)
        // But allow admins for testing
        allow create: if isAnyAdmin() && canAccessEvent(eventId);

        // Logs should not be updated or deleted
        allow update, delete: if false;
      }
    }

    // ============================================
    // USERS
    // ============================================
    match /users/{userId} {
      // Users can read their own data
      // Super admin can read all users
      // Admin roles can read users in their organization
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        isSuperAdmin() ||
        (isAnyAdmin() && belongsToOrganization(resource.data.organizationId))
      );

      // Super admin can create any user
      // Admin responsable can create admins and controllers in their org
      // Admins can create controllers in their org
      // NEW: Allow user to create their own document (needed because createUserWithEmailAndPassword
      //      switches the session to the new user before we can write to Firestore)
      // Using Custom Claims for organizationId check - NO Firestore reads!
      allow create: if isSuperAdmin() ||
                      // User can create their own document (but not as super_admin)
                      (request.auth.uid == userId &&
                       request.resource.data.role != 'super_admin') ||
                      (hasRole('admin_responsable') &&
                       request.resource.data.role in ['admin', 'controlador'] &&
                       request.resource.data.organizationId == getUserOrgId()) ||
                      (hasRole('admin') &&
                       request.resource.data.role == 'controlador' &&
                       request.resource.data.organizationId == getUserOrgId());

      // Users can update their own profile (except role)
      // Admin roles can update users they manage
      allow update: if isAuthenticated() && (
        (request.auth.uid == userId &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'organizationId'])) ||
        isSuperAdmin() ||
        (isAnyAdmin() && belongsToOrganization(resource.data.organizationId))
      );

      // Only super admin can delete users
      // Admin responsable can delete users in their org (except themselves)
      allow delete: if isSuperAdmin() ||
                      (hasRole('admin_responsable') &&
                       belongsToOrganization(resource.data.organizationId) &&
                       request.auth.uid != userId);
    }

    // ============================================
    // LEGACY COLLECTIONS (for backward compatibility)
    // ============================================

    // Legacy participants collection (root level)
    match /participants/{participantId} {
      allow read: if isAuthenticated();
      allow write: if isAnyAdmin();
    }

    // Legacy access_logs collection (root level)
    match /access_logs/{logId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // ============================================
    // DEFAULT: Deny all other access
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
